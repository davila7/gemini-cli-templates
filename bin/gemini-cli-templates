#!/usr/bin/env node

const { spawn } = require('child_process');
const path = require('path');

// Parse command line arguments
const args = process.argv.slice(2);
const analyticsMode = args.includes('--analytics');

// Get the directory where this package is installed
const packageDir = path.dirname(__dirname);

// Function to open browser
function openBrowser(url) {
  const start = (process.platform === 'darwin' ? 'open' : 
                process.platform === 'win32' ? 'start' : 'xdg-open');
  
  spawn(start, [url], { detached: true, stdio: 'ignore' }).unref();
}

// Show help if no analytics flag
if (!analyticsMode) {
  console.log('🚀 Gemini CLI Templates');
  console.log('');
  console.log('Usage:');
  console.log('  gemini-cli-templates --analytics    Start the analytics dashboard');
  console.log('');
  console.log('Options:');
  console.log('  --analytics    Launch the real-time analytics dashboard');
  console.log('  --help         Show this help message');
  console.log('');
  console.log('Example:');
  console.log('  npx gemini-cli-templates --analytics');
  process.exit(0);
}

console.log('🚀 Starting Gemini CLI Analytics Dashboard...');
console.log('📍 Package location:', packageDir);
console.log('🌐 Dashboard will be available at: http://localhost:3337');

// Start the server from the package directory
const child = spawn('node', [path.join(packageDir, 'index.js')], {
  stdio: 'pipe',
  cwd: packageDir
});

// Monitor stdout to detect when server is ready
child.stdout.on('data', (data) => {
  const output = data.toString();
  process.stdout.write(output);
  
  // When server is ready, open browser
  if (output.includes('listening on port 3337')) {
    console.log('🌐 Opening browser...');
    setTimeout(() => {
      openBrowser('http://localhost:3337');
    }, 1000); // Wait 1 second for server to be fully ready
  }
});

// Forward stderr
child.stderr.on('data', (data) => {
  process.stderr.write(data);
});

child.on('close', (code) => {
  if (code !== 0) {
    console.error(`❌ Dashboard exited with code ${code}`);
    process.exit(code);
  }
});

// Handle process termination
process.on('SIGINT', () => {
  console.log('\n👋 Shutting down Gemini CLI Analytics Dashboard...');
  child.kill('SIGINT');
});

process.on('SIGTERM', () => {
  child.kill('SIGTERM');
});